from __future__ import annotations
from typing import List, Dict, Any
from app.services.llm import deepseek_complete


async def generate_gladiator_punishment(
    overdue_goals: List[Dict[str, Any]],
    overdue_challenges: List[Dict[str, Any]],
    overdue_todos: List[Dict[str, Any]]
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤
    
    Args:
        overdue_goals: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
        overdue_challenges: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π  
        overdue_todos: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    
    Returns:
        –¢–µ–∫—Å—Ç –Ω–∞–∫–∞–∑–∞–Ω–∏—è –≤ —Å—Ç–∏–ª–µ –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–æ–π –∞—Ä–µ–Ω—ã
    """
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–ª
    overdue_items = []
    
    if overdue_goals:
        goals_text = "üéØ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏:\n"
        for goal in overdue_goals:
            days_overdue = goal.get('days_overdue', 0)
            goals_text += f"‚Ä¢ {goal['title']} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {days_overdue} –¥–Ω–µ–π)\n"
        overdue_items.append(goals_text)
    
    if overdue_challenges:
        challenges_text = "üèÜ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏:\n"
        for challenge in overdue_challenges:
            days_overdue = challenge.get('days_overdue', 0)
            challenges_text += f"‚Ä¢ {challenge['title']} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {days_overdue} –¥–Ω–µ–π)\n"
        overdue_items.append(challenges_text)
    
    if overdue_todos:
        todos_text = "üìù –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:\n"
        for todo in overdue_todos:
            days_overdue = todo.get('days_overdue', 0)
            todos_text += f"‚Ä¢ {todo['title']} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {days_overdue} –¥–Ω–µ–π)\n"
        overdue_items.append(todos_text)
    
    overdue_summary = "\n".join(overdue_items)
    
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò
    system_prompt = """–¢—ã - —Å—É—Ä–æ–≤—ã–π –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–∏–π —Ç—Ä–µ–Ω–µ—Ä –Ω–∞ –∞—Ä–µ–Ω–µ –∂–∏–∑–Ω–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–∏–¥—É–º–∞—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –¥–ª—è –≥–ª–∞–¥–∏–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å—Ä–æ—á–∏–ª –¥–µ–¥–ª–∞–π–Ω—ã.

–ü–†–ê–í–ò–õ–ê:
1. –ù–∞–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –¥—É—Ö–µ –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–æ–π –∞—Ä–µ–Ω—ã
2. –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã: –º–µ—á–∏, —â–∏—Ç—ã, –∞—Ä–µ–Ω–∞, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å
3. –ù–∞–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º
4. –î–æ–±–∞–≤—å –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É —ç—Ç–æ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç
5. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
6. –ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ —Å—É—Ä–æ–≤–æ–≥–æ, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞
7. –ò–∑–±–µ–≥–∞–π HTML-—Ç–µ–≥–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. –°—É—Ä–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—É
2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–ª
3. –ù–∞–∫–∞–∑–∞–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
4. –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
5. –ì–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–∏–π –¥–µ–≤–∏–∑

–ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è:
"‚öîÔ∏è –ì–õ–ê–î–ò–ê–¢–û–†! –¢—ã –æ—Å—Ä–∞–º–∏–ª —á–µ—Å—Ç—å –∞—Ä–µ–Ω—ã —Å–≤–æ–∏–º–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∞–º–∏! 
–ù–∞ –∞—Ä–µ–Ω–µ –∂–∏–∑–Ω–∏ –Ω–µ—Ç –º–µ—Å—Ç–∞ —Å–ª–∞–±–æ—Å—Ç–∏ –∏ –Ω–µ–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏..."

–ì–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–ª–∞—Ö."""

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_prompt = f"""–ì–ª–∞–¥–∏–∞—Ç–æ—Ä –ø—Ä–æ—Å—Ä–æ—á–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–ª–∞:

{overdue_summary}

–ü—Ä–∏–¥—É–º–∞–π –¥–æ—Å—Ç–æ–π–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ –≥–ª–∞–¥–∏–∞—Ç–æ—Ä—Å–∫–æ–π –∞—Ä–µ–Ω—ã!"""

    try:
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
        full_prompt = f"{system_prompt}\n\n{user_prompt}"
        punishment = await deepseek_complete(
            prompt=full_prompt,
            max_tokens=800
        )
        return punishment
    except Exception as e:
        # Fallback –Ω–∞–∫–∞–∑–∞–Ω–∏–µ
        return f"""‚öîÔ∏è –ì–õ–ê–î–ò–ê–¢–û–†! –¢—ã –æ—Å—Ä–∞–º–∏–ª —á–µ—Å—Ç—å –∞—Ä–µ–Ω—ã!

{overdue_summary}

üèõÔ∏è –ù–ê–ö–ê–ó–ê–ù–ò–ï –ê–†–ï–ù–´:
‚Ä¢ 3 –¥–Ω—è —É—Å–∏–ª–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ 2 —á–∞—Å–∞
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É
‚Ä¢ –ü–µ—Ä–µ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤

üí™ –ü–æ–º–Ω–∏: –Ω–∞ –∞—Ä–µ–Ω–µ –∂–∏–∑–Ω–∏ –Ω–µ—Ç –º–µ—Å—Ç–∞ —Å–ª–∞–±–æ—Å—Ç–∏! 
–ò—Å–ø—Ä–∞–≤–ª—è–π—Å—è –∏–ª–∏ –ø–æ–∫–∏–¥–∞–π –∞—Ä–µ–Ω—É!"""
