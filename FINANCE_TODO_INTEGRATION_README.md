# Интеграция финансовых обязательств с To-Do списком

## Описание

Добавлена функциональность автоматического создания задач в To-Do списке на основе финансовых обязательств (кредиторы и должники). Когда наступает срок выплаты по финансовому обязательству, система автоматически создает соответствующую задачу в To-Do списке пользователя.

## Основные возможности

### 1. Автоматическое создание задач

- **Кредиторы**: Когда наступает срок получения долга, создается задача "Получить долг от [имя]"
- **Должники**: Когда наступает срок выплаты долга, создается задача "Отдать долг [имя]"
- **Приоритет**: Все финансовые задачи создаются с высоким приоритетом
- **Дублирование**: Система предотвращает создание дублирующих задач

### 2. Время создания задач

- Задачи создаются в 6:00 по местному времени пользователя
- Учитывается часовой пояс пользователя
- Задачи создаются только один раз в день для каждого обязательства

### 3. Информативность задач

Каждая созданная задача содержит:
- **Название**: Четкое указание действия (получить/отдать долг)
- **Описание**: Детальная информация об обязательстве
- **Сумма**: Точная сумма долга
- **ID обязательства**: Для связи с финансовым разделом
- **Приоритет**: Высокий приоритет для важности

## Техническая реализация

### Новый сервис: `app/services/finance_todo_manager.py`

#### Основные функции:

```python
async def create_todo_for_financial_obligations(session: AsyncSession, user_id: int) -> None:
    """Создает задачи в To-Do для финансовых обязательств, срок которых наступил сегодня."""

async def create_todos_for_all_users(session: AsyncSession) -> None:
    """Создает задачи для финансовых обязательств всех пользователей."""

async def cleanup_old_financial_todos(session: AsyncSession, user_id: int) -> None:
    """Удаляет старые задачи для финансовых обязательств (старше 7 дней)."""

async def get_financial_todos_for_user(session: AsyncSession, user_id: int) -> List[Todo]:
    """Получает все задачи для финансовых обязательств пользователя."""
```

### Интеграция с планировщиком

Добавлена новая задача в `app/utils/scheduler.py`:

```python
async def _finance_todo_creation_job(self) -> None:
    """Создание задач To-Do для финансовых обязательств с учетом часового пояса пользователя"""
```

### Настройки пользователя

Система учитывает настройки уведомлений пользователя:
- `finance_todo_creation`: Включение/отключение автоматического создания задач
- По умолчанию: включено для всех пользователей

## Структура создаваемых задач

### Для кредиторов:
```
Название: "Получить долг от [имя]"
Описание: "Финансовое обязательство: Кредитор ID:[id] - [имя] должен [сумма] ₽. Описание: [описание]"
Приоритет: "high"
Дата: сегодня
```

### Для должников:
```
Название: "Отдать долг [имя]"
Описание: "Финансовое обязательство: Должник ID:[id] - вы должны [имя] [сумма] ₽. Описание: [описание]"
Приоритет: "high"
Дата: сегодня
```

## Логика работы

### 1. Ежедневная проверка
- Каждую минуту планировщик проверяет время для каждого пользователя
- В 6:00 по местному времени пользователя запускается создание задач

### 2. Поиск обязательств
- Находятся все активные кредиторы с сегодняшней датой
- Находятся все активные должники с сегодняшней датой

### 3. Проверка дублирования
- Проверяется наличие уже созданных задач для этих обязательств
- Предотвращается создание дублирующих задач

### 4. Создание задач
- Для каждого найденного обязательства создается соответствующая задача
- Задачи сохраняются в базе данных

## Тестирование

### Команда для тестирования

```
/test_finance_todo
```

Эта команда позволяет вручную запустить создание задач для финансовых обязательств текущего пользователя.

### Проверка работы

1. Создайте кредитора или должника с сегодняшней датой
2. Используйте команду `/test_finance_todo`
3. Проверьте раздел To-Do на наличие созданных задач

## Настройки и конфигурация

### Включение/отключение функции

Пользователи могут управлять этой функцией через настройки уведомлений:
- `finance_todo_creation: true` - включено (по умолчанию)
- `finance_todo_creation: false` - отключено

### Время создания задач

По умолчанию задачи создаются в 6:00 утра по местному времени пользователя. Это время можно изменить в коде планировщика.

## Преимущества

### 1. Автоматизация
- Не нужно вручную создавать задачи для финансовых обязательств
- Снижается риск забыть о важных выплатах

### 2. Интеграция
- Финансовые обязательства и To-Do список работают вместе
- Единая система управления задачами

### 3. Приоритизация
- Финансовые задачи автоматически получают высокий приоритет
- Важные обязательства не теряются среди других задач

### 4. Информативность
- Каждая задача содержит полную информацию об обязательстве
- Легко найти связанное финансовое обязательство по ID

## Ограничения

### 1. Время создания
- Задачи создаются только один раз в день
- Если обязательство добавлено после 6:00, задача будет создана на следующий день

### 2. Дублирование
- Система предотвращает создание дублирующих задач
- Если задача уже существует, новая не будет создана

### 3. Активность обязательств
- Создаются задачи только для активных обязательств (`is_active = True`)
- Неактивные обязательства игнорируются

## Будущие улучшения

### 1. Гибкость времени
- Возможность настройки времени создания задач пользователем
- Создание задач в реальном времени при добавлении обязательств

### 2. Расширенная информация
- Добавление ссылок на финансовый раздел
- Интеграция с календарем

### 3. Уведомления
- Уведомления о созданных задачах
- Напоминания о приближающихся сроках

## Заключение

Интеграция финансовых обязательств с To-Do списком обеспечивает автоматическое создание важных задач, связанных с финансовыми обязательствами. Это помогает пользователям не забывать о важных выплатах и получать долги вовремя, повышая общую финансовую дисциплину и организованность.
